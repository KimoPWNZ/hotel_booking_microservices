# Database Schema Documentation

## Hotel Service Database

### Tables

#### hotels
Stores hotel information.

```sql
CREATE TABLE hotels (
    id BIGINT GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
    name VARCHAR(255) NOT NULL,
    address VARCHAR(500),
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
);
```

**Indexes:**
- `idx_hotels_name` on `name`

**Relationships:**
- One-to-Many with `rooms`

---

#### rooms
Stores room information for each hotel.

```sql
CREATE TABLE rooms (
    id BIGINT GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
    hotel_id BIGINT NOT NULL,
    number VARCHAR(50) NOT NULL,
    available BOOLEAN DEFAULT TRUE,
    times_booked BIGINT DEFAULT 0,
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    CONSTRAINT fk_rooms_hotel FOREIGN KEY (hotel_id) REFERENCES hotels(id) ON DELETE CASCADE,
    CONSTRAINT uk_hotel_room_number UNIQUE (hotel_id, number)
);
```

**Indexes:**
- `idx_rooms_hotel_id` on `hotel_id`
- `idx_rooms_available` on `available`
- `idx_rooms_times_booked` on `times_booked` (for efficient sorting)

**Relationships:**
- Many-to-One with `hotels` (foreign key: hotel_id)
- One-to-Many with `room_locks`

**Business Logic:**
- `times_booked` incremented on each confirmed booking
- `available` flag for manual control
- Unique constraint on (hotel_id, number) prevents duplicate room numbers

---

#### room_locks
Stores temporary locks on rooms during the booking saga.

```sql
CREATE TABLE room_locks (
    id BIGINT GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
    room_id BIGINT NOT NULL,
    start_date DATE NOT NULL,
    end_date DATE NOT NULL,
    booking_uid VARCHAR(255) NOT NULL,
    request_id VARCHAR(255) NOT NULL UNIQUE,
    expires_at TIMESTAMP NOT NULL,
    CONSTRAINT fk_room_locks_room FOREIGN KEY (room_id) REFERENCES rooms(id) ON DELETE CASCADE
);
```

**Indexes:**
- `idx_room_locks_room_dates` on `(room_id, start_date, end_date)` (for overlap detection)
- `idx_room_locks_request_id` on `request_id` (for idempotency)
- `idx_room_locks_expires_at` on `expires_at` (for cleanup jobs)

**Relationships:**
- Many-to-One with `rooms` (foreign key: room_id)

**Business Logic:**
- Created during booking confirmation (Saga step 1)
- Prevents overlapping bookings (checked via query)
- `request_id` ensures idempotency (unique constraint)
- `expires_at` allows cleanup of stale locks
- Deleted on booking completion or compensation

---

## Booking Service Database

### Tables

#### users
Stores user authentication and authorization data.

```sql
CREATE TABLE users (
    id BIGINT GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
    username VARCHAR(255) NOT NULL UNIQUE,
    password VARCHAR(255) NOT NULL,
    role VARCHAR(50) NOT NULL,
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
);
```

**Indexes:**
- `idx_users_username` on `username` (for login lookups)

**Relationships:**
- One-to-Many with `bookings`

**Business Logic:**
- `password` stored as BCrypt hash
- `role` values: ROLE_USER, ROLE_ADMIN
- Used for JWT generation and validation

---

#### bookings
Stores booking information and saga state.

```sql
CREATE TABLE bookings (
    id BIGINT GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
    user_id BIGINT NOT NULL,
    room_id BIGINT NOT NULL,
    start_date DATE NOT NULL,
    end_date DATE NOT NULL,
    status VARCHAR(50) NOT NULL,
    request_id VARCHAR(255) UNIQUE,
    booking_uid VARCHAR(255) UNIQUE,
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    CONSTRAINT fk_bookings_user FOREIGN KEY (user_id) REFERENCES users(id) ON DELETE CASCADE
);
```

**Indexes:**
- `idx_bookings_user_id` on `user_id` (for user's bookings list)
- `idx_bookings_room_id` on `room_id` (for room availability check)
- `idx_bookings_status` on `status` (for filtering)
- `idx_bookings_dates` on `(start_date, end_date)` (for date range queries)
- `idx_bookings_request_id` on `request_id` (for idempotency)

**Relationships:**
- Many-to-One with `users` (foreign key: user_id)
- References `rooms` in hotel-service (logical, not enforced by FK due to microservices)

**Business Logic:**
- `status` values: PENDING, CONFIRMED, CANCELLED
- Saga state machine:
  1. Created as PENDING
  2. Becomes CONFIRMED after hotel confirms
  3. Becomes CANCELLED on error or user cancellation
- `request_id` ensures idempotency
- `booking_uid` unique identifier for hotel service correlation

---

#### processed_requests
Idempotency tracking table.

```sql
CREATE TABLE processed_requests (
    id BIGINT GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
    request_id VARCHAR(255) NOT NULL UNIQUE,
    booking_id BIGINT,
    status VARCHAR(50) NOT NULL,
    updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
);
```

**Indexes:**
- `idx_processed_requests_request_id` on `request_id` (for fast lookup)

**Relationships:**
- Logical reference to `bookings` (booking_id)

**Business Logic:**
- Stores history of all processed requests
- Enables returning same result for duplicate requests
- `status` tracks saga state: PENDING, CONFIRMED, CANCELLED
- Used to prevent duplicate bookings

---

## Data Flow Example

### Successful Booking

1. **Client** sends POST /booking with `X-Request-Id: abc123`
2. **Booking Service** creates entry in `bookings` (status=PENDING) and `processed_requests` (status=PENDING)
3. **Booking Service** calls Hotel Service confirm-availability
4. **Hotel Service** checks `room_locks` for overlaps
5. **Hotel Service** creates entry in `room_locks`, increments `rooms.times_booked`
6. **Booking Service** updates `bookings.status=CONFIRMED` and `processed_requests.status=CONFIRMED`

### Failed Booking (Compensation)

1. **Client** sends POST /booking
2. **Booking Service** creates `bookings` (status=PENDING)
3. **Booking Service** calls Hotel Service confirm-availability
4. **Hotel Service** finds overlap in `room_locks`, throws error
5. **Booking Service** catches error, calls Hotel Service release
6. **Hotel Service** deletes entry from `room_locks`
7. **Booking Service** updates `bookings.status=CANCELLED`

### Idempotent Request

1. **Client** retries with same `X-Request-Id: abc123`
2. **Booking Service** finds `request_id` in `processed_requests`
3. **Booking Service** returns existing `bookings` entry (no duplicate created)

---

## Migration Strategy

- **Development**: Flyway migrations run automatically on startup
- **Production**: Run migrations separately before deployment
- **Rollback**: Create compensating migration (e.g., V3__rollback_feature.sql)

## Indexing Strategy

Indexes are created on:
1. **Foreign keys** (for JOIN performance)
2. **Unique constraints** (for data integrity)
3. **Frequently queried fields** (username, status, dates)
4. **Sorting fields** (times_booked, created_at)

## Performance Considerations

- **Composite index** on (room_id, start_date, end_date) for overlap detection
- **Partition** `bookings` by created_at if table grows large (future)
- **Archive** old processed_requests periodically
- **Cleanup** expired room_locks via scheduled job

## Schema Versioning

All schema changes are versioned via Flyway:
- `V1__initial_schema.sql` - Initial tables and indexes
- `V2__seed_data.sql` - Test/demo data
- Future: `V3__add_payment_table.sql`, etc.
